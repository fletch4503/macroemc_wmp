{% load partials %}
<!-- Таблица -->
<div class="overflow-x-auto" id="wp-list">
{% partialdef wp-list inline %}
    <table class="table w-full" id="workplaces-table">
        <thead>
            <tr>
                <th>Наименование</th>
                <th>Описание</th>
                <th>Тип</th>
                <th>Отдел</th>
                <th>IP</th>
                <th>MAC</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% partialdef wp-tbody inline %}
                {% for wp in workplaces %}
                    {% include "workplaces/partials/wp_row.html" %}
                {% empty %}
                    <tr><td colspan="6" class="text-center">Нет доступных элементов</td></tr>
                {% endfor %}
            {% endpartialdef wp-tbody %}
            {% for wp in workplaces %}
            {% endfor %}
        </tbody>
    </table>
{% endpartialdef wp-list %}
</div>
<script>
    // JS для показа/скрытия ip/mac — делегирование и поддержка динамической подгрузки через HTMX
    function toggleIpMac(type) {
        const ipField = document.getElementById('ip-field');
        const macField = document.getElementById('mac-field');
        if (!ipField || !macField) return;
        if (type === 'pcplace') {
            ipField.classList.remove('hidden');
            macField.classList.remove('hidden');
        } else {
            ipField.classList.add('hidden');
            macField.classList.add('hidden');
        }
    }

    // Делегируем событие change для select с id 'id_type' — сработает и для динамически подгружаемых форм
    document.body.addEventListener('change', function(event) {
        const target = event.target;
        if (target && target.id === 'id_type') {
            toggleIpMac(target.value);
        }
    });

    // При подстановке содержимого HTMX (после swap) проверяем, нужно ли показать поля
    document.body.addEventListener('htmx:afterSwap', function(event){
        // event.detail.target — элемент, в который HTMX подставил содержимое
        const tgt = event.detail && event.detail.target ? event.detail.target : null;
        if (tgt && tgt.id === 'wp_form') {
            const select = document.getElementById('id_type');
            if (select) toggleIpMac(select.value);
        }
    });

    // Функция для inline edit
    function editWorkplace(button) {
        const row = button.closest('tr');
        const url = button.dataset.url;
        htmx.ajax('GET', url, {target: '#wp_form', swap: 'innerHTML'});
    }

    document.body.addEventListener('replace-row', function(event) {
    const detail = event.detail;
    const rowElement = document.getElementById('workplace-' + detail.pk);
    if (rowElement) {
        rowElement.outerHTML = detail.html;
    }
});

</script>